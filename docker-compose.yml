services:
  # ===================
  # Firecrawl Stack
  # ===================
  firecrawl-api:
    # Build from local fork (vendor/firecrawl submodule)
    # To use upstream image instead: comment build section, uncomment image line
    # image: ghcr.io/firecrawl/firecrawl:latest
    build:
      context: ./vendor/firecrawl/apps/api
      dockerfile: Dockerfile
    ports:
      - "3002:3002"
    environment:
      - PORT=3002
      - HOST=0.0.0.0
      - REDIS_URL=redis://redis:6379
      - REDIS_RATE_LIMIT_URL=redis://redis:6379
      - NUM_WORKERS_PER_QUEUE=6
      - PLAYWRIGHT_MICROSERVICE_URL=http://camoufox:3003/scrape
      - NUQ_DATABASE_URL=postgresql://postgres:postgres@firecrawl-db:5432/postgres
      - NUQ_RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672
      - HTTP_PROXY=http://proxy-adapter:8192
      - HTTPS_PROXY=http://proxy-adapter:8192
      - NO_PROXY=localhost,127.0.0.1,redis,postgres,qdrant
    depends_on:
      firecrawl-db:
        condition: service_healthy
      redis:
        condition: service_started
      camoufox:
        condition: service_started
      rabbitmq:
        condition: service_started
    restart: unless-stopped
    networks:
      - scristill
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1'
        reservations:
          memory: 256M

  playwright:
    build:
      context: .
      dockerfile: Dockerfile.playwright
    ports:
      - "3003:3003"
    environment:
      - PROXY_SERVER=${PLAYWRIGHT_PROXY_SERVER:-http://172.19.0.3:8192}
    restart: unless-stopped
    cap_add:
      - NET_ADMIN  # Required for iptables transparent proxy
    depends_on:
      - proxy-adapter
    networks:
      - scristill
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1'
        reservations:
          memory: 256M

  # Camoufox Browser Service - Anti-bot protected scraping
  # Uses Camoufox (0% detection rate) for HTTPS support on protected sites
  # Migration: Once validated, update firecrawl-api PLAYWRIGHT_MICROSERVICE_URL
  #            to http://camoufox:3003/scrape and remove playwright service
  camoufox:
    build:
      context: .
      dockerfile: Dockerfile.camoufox
    container_name: camoufox-service
    ports:
      - "3004:3003"  # External 3004 for parallel testing, internal 3003
    environment:
      - CAMOUFOX_PORT=3003
      - CAMOUFOX_POOL_SIZE=${CAMOUFOX_POOL_SIZE:-40}
      - CAMOUFOX_TIMEOUT=${CAMOUFOX_TIMEOUT:-180000}
      - CAMOUFOX_NETWORKIDLE_TIMEOUT=${CAMOUFOX_NETWORKIDLE_TIMEOUT:-5000}
      - CAMOUFOX_CONTENT_STABILITY_CHECKS=${CAMOUFOX_CONTENT_STABILITY_CHECKS:-2}
      - CAMOUFOX_CONTENT_STABILITY_INTERVAL=${CAMOUFOX_CONTENT_STABILITY_INTERVAL:-500}
      - CAMOUFOX_PROXY=${CAMOUFOX_PROXY:-}
      - CAMOUFOX_HEADLESS=${CAMOUFOX_HEADLESS:-true}
      - CAMOUFOX_LOG_LEVEL=${LOG_LEVEL:-INFO}
      - CAMOUFOX_LOG_FORMAT=${LOG_FORMAT:-json}
    restart: unless-stopped
    networks:
      - scristill
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2'
        reservations:
          memory: 512M

  # Firecrawl's dedicated PostgreSQL with NUQ schema pre-loaded
  firecrawl-db:
    image: ghcr.io/firecrawl/nuq-postgres:latest
    environment:
      POSTGRES_PASSWORD: postgres
    volumes:
      - firecrawl_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - scristill
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 128M

  # ===================
  # Data Stores
  # ===================
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    restart: unless-stopped
    networks:
      - scristill
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 128M

  rabbitmq:
    image: rabbitmq:3-management-alpine
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    restart: unless-stopped
    networks:
      - scristill
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 128M

  postgres:
    image: postgres:16-alpine
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: ${DB_USER:-scristill}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-scristill}
      POSTGRES_DB: ${DB_NAME:-scristill}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      # Note: init.sql is kept as fallback but migrations are preferred
      # - ./init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-scristill}"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - scristill
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1'
        reservations:
          memory: 256M

  qdrant:
    image: qdrant/qdrant:latest
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_data:/qdrant/storage
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
    restart: unless-stopped
    networks:
      - scristill
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1'
        reservations:
          memory: 512M

  # ===================
  # Anti-Bot Protection
  # ===================
  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:latest
    ports:
      - "8191:8191"
    environment:
      - LOG_LEVEL=info
    restart: unless-stopped
    networks:
      - scristill

  proxy-adapter:
    build:
      context: .
      dockerfile: Dockerfile.proxy
    container_name: proxy-adapter
    ports:
      - "8192:8192"
    environment:
      - API_KEY=${API_KEY:-proxy-adapter-dev-key}
      - PROXY_ADAPTER_PORT=8192
      - FLARESOLVERR_URL=http://flaresolverr:8191
      - FLARESOLVERR_MAX_TIMEOUT=60000
      - FLARESOLVERR_BLOCKED_DOMAINS=weg.net,siemens.com,wattdrive.com
      - LOG_LEVEL=${PROXY_ADAPTER_LOG_LEVEL:-INFO}
    depends_on:
      - flaresolverr
    restart: unless-stopped
    networks:
      - scristill
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'

  # ===================
  # Database Migrations
  # ===================
  migrate:
    build:
      context: .
      dockerfile: Dockerfile
    command: python -m alembic upgrade head
    environment:
      DATABASE_URL: postgresql://${DB_USER:-scristill}:${DB_PASSWORD:-scristill}@postgres:5432/${DB_NAME:-scristill}
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - scristill
    restart: "no"

  # ===================
  # Web UI (Remote Control)
  # ===================
  # NOTE: WebUI not yet implemented - see docs/TODO.md Phase 10
  # Uncomment when ./webui directory is created
  # webui:
  #   build:
  #     context: ./webui
  #     dockerfile: Dockerfile
  #   ports:
  #     - "8080:80"
  #   environment:
  #     - PIPELINE_API_URL=http://pipeline:8000
  #     - API_KEY=${API_KEY}
  #   depends_on:
  #     - pipeline
  #   restart: unless-stopped
  #   networks:
  #     - scristill

  # ===================
  # Pipeline Service
  # ===================
  pipeline:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    environment:
      # Database
      DATABASE_URL: postgresql://${DB_USER:-scristill}:${DB_PASSWORD:-scristill}@postgres:5432/${DB_NAME:-scristill}

      # Redis
      REDIS_URL: redis://redis:6379

      # Qdrant
      QDRANT_URL: http://qdrant:6333

      # Firecrawl
      FIRECRAWL_URL: http://firecrawl-api:3002

      # FlareSolverr
      FLARESOLVERR_URL: http://flaresolverr:8191
      USE_FLARESOLVERR: ${USE_FLARESOLVERR:-true}

      # Security
      API_KEY: ${API_KEY}
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-http://localhost:8080}

      # LLM (your existing vLLM gateway)
      OPENAI_BASE_URL: ${OPENAI_BASE_URL:-http://192.168.0.247:9003/v1}
      OPENAI_EMBEDDING_BASE_URL: ${OPENAI_EMBEDDING_BASE_URL:-http://192.168.0.136:9003/v1}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-ollama}
      LLM_MODEL: ${LLM_MODEL:-gemma3-12b-awq}
      RAG_EMBEDDING_MODEL: ${RAG_EMBEDDING_MODEL:-bge-large-en}

      # Scraping config
      SCRAPE_DELAY_MIN: ${SCRAPE_DELAY_MIN:-2}
      SCRAPE_DELAY_MAX: ${SCRAPE_DELAY_MAX:-5}
      SCRAPE_MAX_CONCURRENT_PER_DOMAIN: ${SCRAPE_MAX_CONCURRENT_PER_DOMAIN:-2}
      SCRAPE_DAILY_LIMIT_PER_DOMAIN: ${SCRAPE_DAILY_LIMIT_PER_DOMAIN:-500}
      SCRAPE_MAX_RETRIES: ${SCRAPE_MAX_RETRIES:-3}
      SCRAPE_TIMEOUT: ${SCRAPE_TIMEOUT:-60}
      CRAWL_DELAY_MS: ${CRAWL_DELAY_MS:-2000}
      CRAWL_MAX_CONCURRENCY: ${CRAWL_MAX_CONCURRENCY:-2}
      MAX_CONCURRENT_CRAWLS: ${MAX_CONCURRENT_CRAWLS:-6}

      # LLM timeouts (matching your config)
      LLM_HTTP_TIMEOUT: ${LLM_HTTP_TIMEOUT:-900}
      LLM_MAX_RETRIES: ${LLM_MAX_RETRIES:-5}
      LLM_RETRY_BACKOFF_MIN: ${LLM_RETRY_BACKOFF_MIN:-2}
      LLM_RETRY_BACKOFF_MAX: ${LLM_RETRY_BACKOFF_MAX:-60}

      # Logging & Monitoring
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      LOG_FORMAT: ${LOG_FORMAT:-json}
      ENABLE_METRICS: ${ENABLE_METRICS:-true}
    volumes:
      - ./prompts:/app/prompts:ro
      - ./reports:/app/reports
    depends_on:
      migrate:
        condition: service_completed_successfully
      redis:
        condition: service_started
      postgres:
        condition: service_healthy
      qdrant:
        condition: service_started
      firecrawl-api:
        condition: service_started
    restart: unless-stopped
    networks:
      - scristill
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2'
        reservations:
          memory: 512M
          cpus: '0.5'

volumes:
  redis_data:
  postgres_data:
  qdrant_data:
  rabbitmq_data:
  firecrawl_postgres_data:

networks:
  scristill:
    driver: bridge
