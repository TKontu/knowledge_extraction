version: "3.8"

services:
  # ===================
  # Firecrawl Stack
  # ===================
  firecrawl-api:
    image: mendableai/firecrawl:latest
    ports:
      - "3002:3002"
    environment:
      - REDIS_URL=redis://redis:6379
      - NUM_WORKERS_PER_QUEUE=2
      - PLAYWRIGHT_MICROSERVICE_URL=http://playwright:3000
    depends_on:
      - redis
      - playwright
    restart: unless-stopped
    networks:
      - techfacts

  playwright:
    image: mendableai/firecrawl-playwright:latest
    ports:
      - "3000:3000"
    restart: unless-stopped
    networks:
      - techfacts

  # ===================
  # Data Stores
  # ===================
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    restart: unless-stopped
    networks:
      - techfacts

  postgres:
    image: postgres:16-alpine
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: ${DB_USER:-techfacts}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-techfacts}
      POSTGRES_DB: ${DB_NAME:-techfacts}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      # Note: init.sql is kept as fallback but migrations are preferred
      # - ./init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-techfacts}"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - techfacts

  qdrant:
    image: qdrant/qdrant:latest
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_data:/qdrant/storage
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
    restart: unless-stopped
    networks:
      - techfacts

  # ===================
  # Anti-Bot (Optional)
  # ===================
  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:latest
    ports:
      - "8191:8191"
    environment:
      - LOG_LEVEL=info
    profiles:
      - antibot
    restart: unless-stopped
    networks:
      - techfacts

  # ===================
  # Database Migrations
  # ===================
  migrate:
    build:
      context: .
      dockerfile: Dockerfile
    command: python -m alembic upgrade head
    environment:
      DATABASE_URL: postgresql://${DB_USER:-techfacts}:${DB_PASSWORD:-techfacts}@postgres:5432/${DB_NAME:-techfacts}
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - techfacts
    restart: "no"

  # ===================
  # Web UI (Remote Control)
  # ===================
  # NOTE: WebUI not yet implemented - see docs/TODO.md Phase 10
  # Uncomment when ./webui directory is created
  # webui:
  #   build:
  #     context: ./webui
  #     dockerfile: Dockerfile
  #   ports:
  #     - "8080:80"
  #   environment:
  #     - PIPELINE_API_URL=http://pipeline:8000
  #     - API_KEY=${API_KEY}
  #   depends_on:
  #     - pipeline
  #   restart: unless-stopped
  #   networks:
  #     - techfacts

  # ===================
  # Pipeline Service
  # ===================
  pipeline:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    environment:
      # Database
      DATABASE_URL: postgresql://${DB_USER:-techfacts}:${DB_PASSWORD:-techfacts}@postgres:5432/${DB_NAME:-techfacts}
      
      # Redis
      REDIS_URL: redis://redis:6379
      
      # Qdrant
      QDRANT_URL: http://qdrant:6333
      
      # Firecrawl
      FIRECRAWL_URL: http://firecrawl-api:3002
      
      # FlareSolverr (optional)
      FLARESOLVERR_URL: http://flaresolverr:8191
      USE_FLARESOLVERR: ${USE_FLARESOLVERR:-false}
      
      # Security
      API_KEY: ${API_KEY}
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-http://localhost:8080}

      # LLM (your existing vLLM gateway)
      OPENAI_BASE_URL: ${OPENAI_BASE_URL:-http://192.168.0.247:9003/v1}
      OPENAI_EMBEDDING_BASE_URL: ${OPENAI_EMBEDDING_BASE_URL:-http://192.168.0.136:9003/v1}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-ollama}
      LLM_MODEL: ${LLM_MODEL:-gemma3-12b-awq}
      RAG_EMBEDDING_MODEL: ${RAG_EMBEDDING_MODEL:-bge-large-en}
      
      # Scraping config
      SCRAPE_DELAY_MIN: ${SCRAPE_DELAY_MIN:-2}
      SCRAPE_DELAY_MAX: ${SCRAPE_DELAY_MAX:-5}
      SCRAPE_MAX_CONCURRENT_PER_DOMAIN: ${SCRAPE_MAX_CONCURRENT_PER_DOMAIN:-2}
      SCRAPE_DAILY_LIMIT_PER_DOMAIN: ${SCRAPE_DAILY_LIMIT_PER_DOMAIN:-500}
      SCRAPE_MAX_RETRIES: ${SCRAPE_MAX_RETRIES:-3}
      SCRAPE_TIMEOUT: ${SCRAPE_TIMEOUT:-60}
      
      # LLM timeouts (matching your config)
      LLM_HTTP_TIMEOUT: ${LLM_HTTP_TIMEOUT:-900}
      LLM_MAX_RETRIES: ${LLM_MAX_RETRIES:-5}
      LLM_RETRY_BACKOFF_MIN: ${LLM_RETRY_BACKOFF_MIN:-2}
      LLM_RETRY_BACKOFF_MAX: ${LLM_RETRY_BACKOFF_MAX:-60}
      
      # Logging & Monitoring
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      LOG_FORMAT: ${LOG_FORMAT:-json}
      ENABLE_METRICS: ${ENABLE_METRICS:-true}
    volumes:
      - ./prompts:/app/prompts:ro
      - ./reports:/app/reports
    depends_on:
      migrate:
        condition: service_completed_successfully
      redis:
        condition: service_started
      postgres:
        condition: service_healthy
      qdrant:
        condition: service_started
      firecrawl-api:
        condition: service_started
    restart: unless-stopped
    networks:
      - techfacts

volumes:
  redis_data:
  postgres_data:
  qdrant_data:

networks:
  techfacts:
    driver: bridge
