# Production compose file - uses pre-built images instead of local builds
# Usage: docker compose -f docker-compose.prod.yml up -d
#
# Required: Set REGISTRY_PREFIX in .env or environment
# Example: REGISTRY_PREFIX=ghcr.io/tkontu

services:
  # ===================
  # Firecrawl Stack
  # ===================
  firecrawl-api:
    image: ${REGISTRY_PREFIX:-ghcr.io/tkontu}/firecrawl-api:${FIRECRAWL_TAG:-latest}
    ports:
      - "3002:3002"
    environment:
      - PORT=3002
      - HOST=0.0.0.0
      - REDIS_URL=redis://redis:6379
      - REDIS_RATE_LIMIT_URL=redis://redis:6379
      - NUM_WORKERS_PER_QUEUE=6
      - PLAYWRIGHT_MICROSERVICE_URL=http://camoufox:3003/scrape
      - NUQ_DATABASE_URL=postgresql://postgres:postgres@firecrawl-db:5432/postgres
      - NUQ_RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672
      - HTTP_PROXY=http://proxy-adapter:8192
      - HTTPS_PROXY=http://proxy-adapter:8192
      - NO_PROXY=localhost,127.0.0.1,redis,postgres,qdrant
    depends_on:
      firecrawl-db:
        condition: service_healthy
      redis:
        condition: service_started
      camoufox:
        condition: service_started
      rabbitmq:
        condition: service_started
    restart: unless-stopped
    networks:
      - scristill
    deploy:
      resources:
        limits:
          memory: 8G
          cpus: '1'
        reservations:
          memory: 512M

  camoufox:
    image: ${REGISTRY_PREFIX:-ghcr.io/tkontu}/camoufox:${CAMOUFOX_TAG:-latest}
    ports:
      - "3004:3003"
    environment:
      - CAMOUFOX_PORT=3003
      - CAMOUFOX_POOL_SIZE=${CAMOUFOX_POOL_SIZE:-40}
      - CAMOUFOX_TIMEOUT=${CAMOUFOX_TIMEOUT:-180000}
      - CAMOUFOX_NETWORKIDLE_TIMEOUT=${CAMOUFOX_NETWORKIDLE_TIMEOUT:-5000}
      - CAMOUFOX_CONTENT_STABILITY_CHECKS=${CAMOUFOX_CONTENT_STABILITY_CHECKS:-2}
      - CAMOUFOX_CONTENT_STABILITY_INTERVAL=${CAMOUFOX_CONTENT_STABILITY_INTERVAL:-500}
      - CAMOUFOX_PROXY=${CAMOUFOX_PROXY:-}
      - CAMOUFOX_HEADLESS=${CAMOUFOX_HEADLESS:-true}
      - CAMOUFOX_LOG_LEVEL=${LOG_LEVEL:-INFO}
      - CAMOUFOX_LOG_FORMAT=${LOG_FORMAT:-json}
    restart: unless-stopped
    networks:
      - scristill
    deploy:
      resources:
        limits:
          memory: 16G
          cpus: '3'
        reservations:
          memory: 1G

  firecrawl-db:
    image: ghcr.io/firecrawl/nuq-postgres:latest
    environment:
      POSTGRES_PASSWORD: postgres
    volumes:
      - firecrawl_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - scristill

  # ===================
  # Data Stores
  # ===================
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    restart: unless-stopped
    networks:
      - scristill

  rabbitmq:
    image: rabbitmq:3-management-alpine
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    restart: unless-stopped
    networks:
      - scristill

  postgres:
    image: postgres:16-alpine
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: ${DB_USER:-scristill}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-scristill}
      POSTGRES_DB: ${DB_NAME:-scristill}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-scristill}"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - scristill

  qdrant:
    image: qdrant/qdrant:latest
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_data:/qdrant/storage
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
    restart: unless-stopped
    networks:
      - scristill

  # ===================
  # Anti-Bot Protection
  # ===================
  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:latest
    ports:
      - "8191:8191"
    environment:
      - LOG_LEVEL=info
    restart: unless-stopped
    networks:
      - scristill

  proxy-adapter:
    image: ${REGISTRY_PREFIX:-ghcr.io/tkontu}/proxy-adapter:${PROXY_ADAPTER_TAG:-latest}
    ports:
      - "8192:8192"
    environment:
      - API_KEY=${API_KEY:-proxy-adapter-dev-key}
      - PROXY_ADAPTER_PORT=8192
      - FLARESOLVERR_URL=http://flaresolverr:8191
      - FLARESOLVERR_MAX_TIMEOUT=60000
      - FLARESOLVERR_BLOCKED_DOMAINS=weg.net,siemens.com,wattdrive.com
      - LOG_LEVEL=${PROXY_ADAPTER_LOG_LEVEL:-INFO}
    depends_on:
      - flaresolverr
    restart: unless-stopped
    networks:
      - scristill

  # ===================
  # Database Migrations
  # ===================
  migrate:
    image: ${REGISTRY_PREFIX:-ghcr.io/tkontu}/pipeline:${PIPELINE_TAG:-latest}
    command: python -m alembic upgrade head
    environment:
      DATABASE_URL: postgresql://${DB_USER:-scristill}:${DB_PASSWORD:-scristill}@postgres:5432/${DB_NAME:-scristill}
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - scristill
    restart: "no"

  # ===================
  # Pipeline Service
  # ===================
  pipeline:
    image: ${REGISTRY_PREFIX:-ghcr.io/tkontu}/pipeline:${PIPELINE_TAG:-latest}
    ports:
      - "${PIPELINE_PORT:-8742}:8000"
    environment:
      DATABASE_URL: postgresql://${DB_USER:-scristill}:${DB_PASSWORD:-scristill}@postgres:5432/${DB_NAME:-scristill}
      REDIS_URL: redis://redis:6379
      QDRANT_URL: http://qdrant:6333
      FIRECRAWL_URL: http://firecrawl-api:3002
      FLARESOLVERR_URL: http://flaresolverr:8191
      USE_FLARESOLVERR: ${USE_FLARESOLVERR:-true}
      API_KEY: ${API_KEY}
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-http://localhost:8080}
      OPENAI_BASE_URL: ${OPENAI_BASE_URL:-http://192.168.0.247:9003/v1}
      OPENAI_EMBEDDING_BASE_URL: ${OPENAI_EMBEDDING_BASE_URL:-http://192.168.0.136:9003/v1}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-ollama}
      LLM_MODEL: ${LLM_MODEL:-gemma3-12b-awq}
      RAG_EMBEDDING_MODEL: ${RAG_EMBEDDING_MODEL:-bge-large-en}
      SCRAPE_DELAY_MIN: ${SCRAPE_DELAY_MIN:-2}
      SCRAPE_DELAY_MAX: ${SCRAPE_DELAY_MAX:-5}
      SCRAPE_MAX_CONCURRENT_PER_DOMAIN: ${SCRAPE_MAX_CONCURRENT_PER_DOMAIN:-2}
      SCRAPE_DAILY_LIMIT_PER_DOMAIN: ${SCRAPE_DAILY_LIMIT_PER_DOMAIN:-500}
      SCRAPE_MAX_RETRIES: ${SCRAPE_MAX_RETRIES:-3}
      SCRAPE_TIMEOUT: ${SCRAPE_TIMEOUT:-60}
      CRAWL_DELAY_MS: ${CRAWL_DELAY_MS:-2000}
      CRAWL_MAX_CONCURRENCY: ${CRAWL_MAX_CONCURRENCY:-2}
      MAX_CONCURRENT_CRAWLS: ${MAX_CONCURRENT_CRAWLS:-6}
      LLM_HTTP_TIMEOUT: ${LLM_HTTP_TIMEOUT:-900}
      LLM_MAX_RETRIES: ${LLM_MAX_RETRIES:-5}
      LLM_RETRY_BACKOFF_MIN: ${LLM_RETRY_BACKOFF_MIN:-2}
      LLM_RETRY_BACKOFF_MAX: ${LLM_RETRY_BACKOFF_MAX:-60}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      LOG_FORMAT: ${LOG_FORMAT:-json}
      ENABLE_METRICS: ${ENABLE_METRICS:-true}
    volumes:
      - ./prompts:/app/prompts:ro
      - ./reports:/app/reports
    depends_on:
      migrate:
        condition: service_completed_successfully
      redis:
        condition: service_started
      postgres:
        condition: service_healthy
      qdrant:
        condition: service_started
      firecrawl-api:
        condition: service_started
    restart: unless-stopped
    networks:
      - scristill

volumes:
  redis_data:
  postgres_data:
  qdrant_data:
  rabbitmq_data:
  firecrawl_postgres_data:

networks:
  scristill:
    driver: bridge
